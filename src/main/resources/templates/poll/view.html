<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title th:text="${poll.title}">Umfrage</title>
    <script src="/js/vendor/htmx.min.js"></script>
    <link rel="stylesheet" href="/css/app.css">
</head>
<body>
<div class="page-shell" id="poll-content" th:fragment="pollContent">
    <header>
        <h1 th:text="${poll.title}">Umfrage</h1>
        <p class="badge badge--admin" th:if="${adminView}">Admin</p>
    </header>

    <main class="panel-grid">
        <section class="content-card">
            <p th:text="${poll.description}">Beschreibung</p>
        </section>

        <section class="votes-panel" th:if="${!adminView}">
            <div class="section-heading">
                <h2>Stimmabgaben zur Umfrage</h2>
                <p>Tragen Sie Ihre Verfügbarkeit ein oder bearbeiten Sie bestehende Einträge.</p>
            </div>
            <div class="votes-table-wrap">
            <table id="poll-votes-table" class="votes-table">
            <thead>
            <tr>
                <th scope="col" class="votes-table__name">Teilnehmende</th>
                <th th:each="group : ${monthGroups}"
                    scope="colgroup"
                    class="votes-table__month"
                    th:colspan="${group.span}"
                    th:text="${group.label}">Monat</th>
                <th scope="col" class="votes-table__edit">Bearbeiten</th>
            </tr>
            <tr>
                <th scope="col"> </th>
                <th th:each="group : ${dateGroups}"
                    scope="colgroup"
                    class="votes-table__date-group"
                    th:colspan="${group.span}"
                    th:text="${group.label}">Datum</th>
                <th scope="col"> </th>
            </tr>
            <tr>
                <th scope="col"> </th>
                <th th:each="header : ${voteOptionHeaders}"
                    scope="col"
                    class="votes-table__date"
                    th:attr="data-date=${header.option.date}"
                    th:text="${header.label}">Datum</th>
                <th scope="col"> </th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="row : ${participantRows}"
                th:attr="data-edit-row=${row.name}"
                th:id="${'row-' + row.responseId}">
                <th scope="row" class="votes-table__name" th:text="${row.name}">Name</th>
                <td th:each="cell : ${row.cells}" class="votes-table__cell">
                    <span class="votes-table__marker" th:classappend="${cell.markerClass}" th:text="${cell.symbol}">✓</span>
                </td>
                <td class="votes-table__edit">
                    <button type="button"
                            class="icon-button"
                            th:attr="aria-label=${'Zeile bearbeiten: ' + row.name},
                                     hx-get=@{/poll/{pollId}/responses/{responseId}/edit(pollId=${pollId},responseId=${row.responseId})}"
                            hx-target="closest tr"
                            hx-swap="outerHTML">
                        ✎
                    </button>
                </td>
            </tr>
            <tr data-add-row="true" class="votes-table__add-row">
                <th scope="row" class="votes-table__name">
                    <label for="participant-name">Ihr Name</label>
                    <input id="participant-name" name="participantName" type="text" required form="add-vote-form">
                </th>
                <td th:each="header : ${voteOptionHeaders}" class="votes-table__cell">
                    <select th:id="${'vote-new-' + header.option.optionId}"
                            th:name="${'vote_new_' + header.option.optionId}"
                            form="add-vote-form">
                        <option value="YES">✅</option>
                        <option value="IF_NEEDED">(✔️)</option>
                        <option value="NO">❌</option>
                    </select>
                </td>
                <td class="votes-table__edit">
                    <button type="submit" form="add-vote-form">Speichern</button>
                </td>
            </tr>
            </tbody>
            <tfoot>
            <tr th:replace="poll/summary-row :: row"></tr>
            </tfoot>
        </table>
            </div>

        <form id="add-vote-form" th:action="@{/poll/{pollId}/vote(pollId=${pollId})}" method="post"></form>
        </section>

        <section class="admin-layout" th:if="${adminView}">
            <div class="admin-main">
                <section class="admin-panel">
                    <h2>Optionen</h2>
                    <div th:replace="poll/options-list :: optionsList"></div>
                </section>
                <section class="admin-panel">
                    <h2>Optionen bearbeiten</h2>
                    <form th:action="@{/poll/{pollId}-{adminSecret}/options/add(pollId=${pollId},adminSecret=${adminSecret})}"
                          th:attr="hx-post=@{/poll/{pollId}-{adminSecret}/options/add(pollId=${pollId},adminSecret=${adminSecret})}"
                          id="admin-options-form"
                          method="post"
                          hx-target="#options-list"
                          hx-swap="outerHTML"
                          hx-on::after-request="if(event.detail.successful) this.reset()">
                        <div class="form-row">
                            <label for="new-date">Neues Datum</label>
                            <input id="new-date" name="date" type="date" required>
                        </div>
                        <div id="admin-start-times" th:if="${poll.eventType.name() == 'INTRADAY'}">
                            <div class="form-row" data-time-row>
                                <label for="new-start-time">Startzeit</label>
                                <input id="new-start-time" name="startTime" type="time" required>
                            </div>
                        </div>
                        <div class="actions">
                            <button th:if="${poll.eventType.name() == 'INTRADAY'}" id="admin-add-time" type="button">Uhrzeit hinzufügen</button>
                            <button th:if="${poll.eventType.name() == 'INTRADAY'}" id="admin-remove-time" type="button">Uhrzeit entfernen</button>
                            <button type="submit" hx-indicator=".htmx-indicator"
                                    th:text="${poll.eventType.name() == 'INTRADAY'} ? 'Tag hinzufügen' : 'Datum hinzufügen'">Datum hinzufügen</button>
                            <span class="htmx-indicator" aria-live="polite">Lade…</span>
                        </div>
                    </form>
                </section>
            </div>
            <aside class="admin-side">
                <section class="info-card" th:if="${emailDisabled}">
                    <p><strong>Emailversand ist deaktiviert.</strong></p>
                </section>
                <section class="info-card" th:if="${emailFailed}">
                    <p><strong>E-Mail konnte nicht gesendet werden.</strong></p>
                    <p>Bitte teilen Sie die Links unten manuell.</p>
                </section>
                <section class="info-card">
                    <h2>Links zum Teilen</h2>
                    <div class="copy-field">
                        <label>Link für Teilnehmende</label>
                        <code id="participant-link" th:text="${participantShareUrl}">https://example/poll/...</code>
                        <button type="button" data-copy-target="participant-link">Kopiere Link</button>
                    </div>
                </section>
                <section class="info-card">
                    <div class="copy-field">
                        <label>Admin-Link</label>
                        <code id="admin-link" th:text="${adminShareUrl}">https://example/poll/...-...</code>
                        <button type="button" data-copy-target="admin-link">Kopiere Link</button>
                    </div>
                </section>
            </aside>
        </section>
    </main>
</div>
<script src="/js/woodle-ui.js"></script>
</body>
</html>
