<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title th:text="${poll.title}">Umfrage</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <link rel="stylesheet" href="/css/app.css">
</head>
<body>
<header>
    <h1 th:text="${poll.title}">Umfrage</h1>
    <p th:if="${adminView}">Admin</p>
</header>

<main>
    <section>
        <h2>Beschreibung</h2>
        <p th:text="${poll.description}">Beschreibung</p>
    </section>

    <section th:if="${!adminView}">
        <h2>Stimmabgaben zur Umfrage</h2>
        <table id="poll-votes-table" class="votes-table">
            <thead>
            <tr>
                <th scope="col" class="votes-table__name">Teilnehmende</th>
                <th th:each="group : ${monthGroups}"
                    scope="colgroup"
                    class="votes-table__month"
                    th:colspan="${group.span}"
                    th:text="${group.label}">Monat</th>
                <th scope="col" class="votes-table__edit">Bearbeiten</th>
            </tr>
            <tr>
                <th scope="col"> </th>
                <th th:each="header : ${voteOptionHeaders}"
                    scope="col"
                    class="votes-table__date"
                    th:attr="data-date=${header.option.date}"
                    th:text="${header.label}">Datum</th>
                <th scope="col"> </th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="row : ${participantRows}"
                th:attr="data-edit-row=${row.name}"
                th:id="${'row-' + row.responseId}">
                <th scope="row" class="votes-table__name" th:text="${row.name}">Name</th>
                <td th:each="cell : ${row.cells}" class="votes-table__cell">
                    <span class="votes-table__marker" th:text="${cell.symbol}">✓</span>
                </td>
                <td class="votes-table__edit">
                    <button type="button"
                            class="icon-button"
                            th:attr="aria-label=${'Zeile bearbeiten: ' + row.name},
                                     hx-get=@{/poll/{pollId}/responses/{responseId}/edit(pollId=${pollId},responseId=${row.responseId})}"
                            hx-target="closest tr"
                            hx-swap="outerHTML">
                        ✎
                    </button>
                </td>
            </tr>
            <tr data-add-row="true" class="votes-table__add-row">
                <th scope="row" class="votes-table__name">
                    <label for="participant-name">Ihr Name</label>
                    <input id="participant-name" name="participantName" type="text" required form="add-vote-form">
                </th>
                <td th:each="header : ${voteOptionHeaders}" class="votes-table__cell">
                    <select th:id="${'vote-new-' + header.option.optionId}"
                            th:name="${'vote_new_' + header.option.optionId}"
                            form="add-vote-form">
                        <option value="YES">Ja</option>
                        <option value="IF_NEEDED">Wenn nötig</option>
                        <option value="NO">Nein</option>
                    </select>
                </td>
                <td class="votes-table__edit">
                    <button type="submit" form="add-vote-form">Speichern</button>
                </td>
            </tr>
            </tbody>
            <tfoot>
            <tr class="summary-row">
                <th scope="row" class="votes-table__summary-label">Summe</th>
                <td th:each="cell : ${summaryCells}" class="votes-table__summary">
                    <span th:text="${cell.count}">0</span>
                    <span th:if="${cell.best}" class="votes-table__best">★</span>
                </td>
                <td> </td>
            </tr>
            </tfoot>
        </table>

        <form id="add-vote-form" th:action="@{/poll/{pollId}/vote(pollId=${pollId})}" method="post"></form>
    </section>

    <section th:if="${adminView}">
        <h2>Optionen</h2>
        <div th:replace="poll/options-list :: optionsList"></div>
    </section>

    <section th:if="${adminView}">
        <h2>Optionen bearbeiten</h2>
        <form th:action="@{/poll/{pollId}-{adminSecret}/options/add(pollId=${pollId},adminSecret=${adminSecret})}"
              th:attr="hx-post=@{/poll/{pollId}-{adminSecret}/options/add(pollId=${pollId},adminSecret=${adminSecret})}"
              method="post"
              hx-target="#options-list"
              hx-swap="outerHTML">
            <div class="form-row">
                <label for="new-date">Neues Datum</label>
                <input id="new-date" name="date" type="date" required>
            </div>
            <div class="actions">
                <button type="submit" hx-indicator=".htmx-indicator">Datum hinzufügen</button>
                <span class="htmx-indicator" aria-live="polite">Lade…</span>
            </div>
        </form>
    </section>

    <section th:if="${adminView}">
        <h2>Links zum Teilen</h2>
        <div class="form-row">
            <label>Link für Teilnehmende</label>
            <div class="actions">
                <code id="participant-link" th:text="${participantShareUrl}">https://example/poll/...</code>
                <button type="button" data-copy-target="participant-link">Kopiere Link</button>
            </div>
        </div>
        <div class="form-row">
            <label>Admin-Link</label>
            <div class="actions">
                <code id="admin-link" th:text="${adminShareUrl}">https://example/poll/...-...</code>
                <button type="button" data-copy-target="admin-link">Kopiere Link</button>
            </div>
        </div>
    </section>
</main>
<script>
    document.querySelectorAll("[data-copy-target]").forEach((button) => {
        button.addEventListener("click", async () => {
            const targetId = button.getAttribute("data-copy-target");
            const target = document.getElementById(targetId);
            if (!target) {
                return;
            }
            try {
                await navigator.clipboard.writeText(target.textContent || "");
            } catch (error) {
                const range = document.createRange();
                range.selectNodeContents(target);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                document.execCommand("copy");
                selection.removeAllRanges();
            }
        });
    });
</script>
</body>
</html>
