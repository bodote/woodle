<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PollNewPageController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">woodle</a> &gt; <a href="index.source.html" class="el_package">io.github.bodote.woodle.adapter.in.web</a> &gt; <span class="el_source">PollNewPageController.java</span></div><h1>PollNewPageController.java</h1><pre class="source lang-java linenums">package io.github.bodote.woodle.adapter.in.web;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.ui.Model;

import jakarta.servlet.http.HttpSession;
import java.time.LocalDate;
import java.time.LocalTime;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Map;

@Controller
<span class="fc" id="L18">public class PollNewPageController {</span>

    private static final String STEP2_DATE_COUNT = &quot;step2DateCount&quot;;
    private static final int STEP2_MIN_DATES = 1;
    private static final int STEP2_DEFAULT_DATES = 2;
    private static final int STEP2_MAX_DATES = 10;
    private static final String EMAIL_ERROR_MESSAGE = &quot;Bitte eine g√ºltige E-Mail-Adresse eingeben&quot;;

    @GetMapping(&quot;/poll/new&quot;)
    public String renderStep1(Model model, HttpSession session) {
<span class="fc" id="L28">        WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L29">        applyStep1Model(model, state, null, false);</span>
<span class="fc" id="L30">        return &quot;poll/new-step1&quot;;</span>
    }

    @GetMapping(&quot;/poll/step-1/email-check&quot;)
    public String validateEmail(@RequestParam(&quot;authorEmail&quot;) String authorEmail, Model model, HttpSession session) {
<span class="fc" id="L35">        WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L36">        applyStep1Model(model, state, authorEmail, isInvalidEmail(authorEmail));</span>
<span class="fc" id="L37">        return &quot;poll/new-step1 :: emailField&quot;;</span>
    }

    @GetMapping(&quot;/poll/step-2&quot;)
    public String renderStep2(Model model, HttpSession session) {
<span class="fc" id="L42">        int count = getOrInitDateCount(session);</span>
<span class="fc" id="L43">        model.addAttribute(&quot;dateCount&quot;, count);</span>
<span class="fc" id="L44">        WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L45">        model.addAttribute(&quot;eventType&quot;, state.eventType());</span>
<span class="fc" id="L46">        return &quot;poll/new-step2&quot;;</span>
    }

    @PostMapping(&quot;/poll/step-2&quot;)
    public String handleStep1(
            @RequestParam(&quot;authorName&quot;) String authorName,
            @RequestParam(&quot;authorEmail&quot;) String authorEmail,
            @RequestParam(&quot;pollTitle&quot;) String pollTitle,
            @RequestParam(value = &quot;description&quot;, required = false) String description,
            Model model,
            HttpSession session
    ) {
<span class="fc bfc" id="L58" title="All 2 branches covered.">        if (isInvalidEmail(authorEmail)) {</span>
<span class="fc" id="L59">            WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L60">            state.setAuthorName(authorName);</span>
<span class="fc" id="L61">            state.setAuthorEmail(authorEmail);</span>
<span class="fc" id="L62">            state.setTitle(pollTitle);</span>
<span class="fc" id="L63">            state.setDescription(description);</span>
<span class="fc" id="L64">            applyStep1Model(model, state, authorEmail, true);</span>
<span class="fc" id="L65">            return &quot;poll/new-step1&quot;;</span>
        }
<span class="fc" id="L67">        WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L68">        state.setAuthorName(authorName);</span>
<span class="fc" id="L69">        state.setAuthorEmail(authorEmail);</span>
<span class="fc" id="L70">        state.setTitle(pollTitle);</span>
<span class="fc" id="L71">        state.setDescription(description);</span>
<span class="fc" id="L72">        session.setAttribute(WizardState.SESSION_KEY, state);</span>
<span class="fc" id="L73">        return &quot;redirect:/poll/step-2&quot;;</span>
    }

    @GetMapping(&quot;/poll/step-2/options/add&quot;)
    public String addDateOption(Model model, HttpSession session) {
<span class="fc" id="L78">        int count = Math.min(getOrInitDateCount(session) + 1, STEP2_MAX_DATES);</span>
<span class="fc" id="L79">        session.setAttribute(STEP2_DATE_COUNT, count);</span>
<span class="fc" id="L80">        model.addAttribute(&quot;dateCount&quot;, count);</span>
<span class="fc" id="L81">        WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L82">        model.addAttribute(&quot;eventType&quot;, state.eventType());</span>
<span class="fc" id="L83">        return resolveOptionsFragment(state);</span>
    }

    @GetMapping(&quot;/poll/step-2/options/remove&quot;)
    public String removeDateOption(Model model, HttpSession session) {
<span class="fc" id="L88">        int count = Math.max(getOrInitDateCount(session) - 1, STEP2_MIN_DATES);</span>
<span class="fc" id="L89">        session.setAttribute(STEP2_DATE_COUNT, count);</span>
<span class="fc" id="L90">        model.addAttribute(&quot;dateCount&quot;, count);</span>
<span class="fc" id="L91">        WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L92">        model.addAttribute(&quot;eventType&quot;, state.eventType());</span>
<span class="fc" id="L93">        return resolveOptionsFragment(state);</span>
    }

    @GetMapping(&quot;/poll/step-2/event-type&quot;)
    public String setEventType(@RequestParam(&quot;eventType&quot;) io.github.bodote.woodle.domain.model.EventType eventType,
                               Model model,
                               HttpSession session) {
<span class="fc" id="L100">        WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L101">        state.setEventType(eventType);</span>
<span class="fc" id="L102">        session.setAttribute(WizardState.SESSION_KEY, state);</span>
<span class="fc" id="L103">        model.addAttribute(&quot;eventType&quot;, eventType);</span>
<span class="fc" id="L104">        model.addAttribute(&quot;dateCount&quot;, getOrInitDateCount(session));</span>
<span class="fc" id="L105">        return &quot;poll/step2-event-options :: eventOptions&quot;;</span>
    }

    @GetMapping(&quot;/poll/step-3&quot;)
    public String renderStep3(Model model, HttpSession session) {
<span class="fc" id="L110">        WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L111">        model.addAttribute(&quot;dates&quot;, state.dates());</span>
<span class="fc" id="L112">        model.addAttribute(&quot;eventType&quot;, state.eventType());</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (state.eventType() == io.github.bodote.woodle.domain.model.EventType.INTRADAY) {</span>
<span class="fc" id="L114">            model.addAttribute(&quot;dateSummaries&quot;, buildIntradaySummaries(state));</span>
        }
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (!state.dates().isEmpty()) {</span>
<span class="fc" id="L117">            LocalDate lastDate = state.dates().stream().max(Comparator.naturalOrder()).orElse(null);</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">            if (lastDate != null) {</span>
<span class="fc" id="L119">                model.addAttribute(&quot;expiresAt&quot;, lastDate.plusWeeks(4));</span>
            }
        }
<span class="fc" id="L122">        return &quot;poll/new-step3&quot;;</span>
    }

    @PostMapping(&quot;/poll/step-3&quot;)
    public String handleStep2(
            @RequestParam(value = &quot;eventType&quot;, defaultValue = &quot;ALL_DAY&quot;) io.github.bodote.woodle.domain.model.EventType eventType,
            @RequestParam(value = &quot;durationMinutes&quot;, required = false) Integer durationMinutes,
            HttpSession session,
            jakarta.servlet.http.HttpServletRequest request
    ) {
<span class="fc" id="L132">        WizardState state = getOrInitWizard(session);</span>
<span class="fc" id="L133">        state.setEventType(eventType);</span>
<span class="fc" id="L134">        state.setDurationMinutes(durationMinutes);</span>
<span class="fc" id="L135">        state.setDates(extractDates(request.getParameterMap()));</span>
<span class="fc" id="L136">        state.setStartTimes(extractStartTimes(request.getParameterMap(), eventType));</span>
<span class="fc" id="L137">        session.setAttribute(WizardState.SESSION_KEY, state);</span>
<span class="fc" id="L138">        return &quot;redirect:/poll/step-3&quot;;</span>
    }

    private WizardState getOrInitWizard(HttpSession session) {
<span class="fc" id="L142">        Object value = session.getAttribute(WizardState.SESSION_KEY);</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">        if (value instanceof WizardState state) {</span>
<span class="fc" id="L144">            return state;</span>
        }
<span class="fc" id="L146">        WizardState state = new WizardState();</span>
<span class="fc" id="L147">        session.setAttribute(WizardState.SESSION_KEY, state);</span>
<span class="fc" id="L148">        return state;</span>
    }

    private List&lt;LocalDate&gt; extractDates(Map&lt;String, String[]&gt; parameterMap) {
<span class="fc" id="L152">        List&lt;Map.Entry&lt;String, String[]&gt;&gt; entries = new ArrayList&lt;&gt;(parameterMap.entrySet());</span>
<span class="fc" id="L153">        entries.sort(Comparator.comparing(Map.Entry::getKey));</span>
<span class="fc" id="L154">        List&lt;LocalDate&gt; dates = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        for (Map.Entry&lt;String, String[]&gt; entry : entries) {</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">            if (!entry.getKey().startsWith(&quot;dateOption&quot;)) {</span>
<span class="fc" id="L157">                continue;</span>
            }
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">            if (entry.getValue().length == 0) {</span>
<span class="nc" id="L160">                continue;</span>
            }
<span class="fc" id="L162">            String value = entry.getValue()[0];</span>
<span class="pc bpc" id="L163" title="2 of 4 branches missed.">            if (value == null || value.isBlank()) {</span>
<span class="nc" id="L164">                continue;</span>
            }
<span class="fc" id="L166">            dates.add(LocalDate.parse(value));</span>
<span class="fc" id="L167">        }</span>
<span class="fc" id="L168">        return dates;</span>
    }

    private List&lt;LocalTime&gt; extractStartTimes(Map&lt;String, String[]&gt; parameterMap,
                                              io.github.bodote.woodle.domain.model.EventType eventType) {
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">        if (eventType != io.github.bodote.woodle.domain.model.EventType.INTRADAY) {</span>
<span class="fc" id="L174">            return List.of();</span>
        }
<span class="nc" id="L176">        List&lt;Map.Entry&lt;String, String[]&gt;&gt; entries = new ArrayList&lt;&gt;(parameterMap.entrySet());</span>
<span class="nc" id="L177">        entries.sort(Comparator.comparing(Map.Entry::getKey));</span>
<span class="nc" id="L178">        List&lt;LocalTime&gt; times = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        for (Map.Entry&lt;String, String[]&gt; entry : entries) {</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (!entry.getKey().startsWith(&quot;startTime&quot;)) {</span>
<span class="nc" id="L181">                continue;</span>
            }
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (entry.getValue().length == 0) {</span>
<span class="nc" id="L184">                continue;</span>
            }
<span class="nc" id="L186">            String value = entry.getValue()[0];</span>
<span class="nc bnc" id="L187" title="All 4 branches missed.">            if (value == null || value.isBlank()) {</span>
<span class="nc" id="L188">                continue;</span>
            }
<span class="nc" id="L190">            times.add(LocalTime.parse(value));</span>
<span class="nc" id="L191">        }</span>
<span class="nc" id="L192">        return times;</span>
    }

    private List&lt;String&gt; buildIntradaySummaries(WizardState state) {
<span class="fc" id="L196">        List&lt;String&gt; summaries = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L197">        List&lt;LocalDate&gt; dates = state.dates();</span>
<span class="fc" id="L198">        List&lt;LocalTime&gt; times = state.startTimes();</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">        for (int i = 0; i &lt; dates.size(); i++) {</span>
<span class="fc" id="L200">            LocalDate date = dates.get(i);</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">            LocalTime time = i &lt; times.size() ? times.get(i) : null;</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">            if (time != null) {</span>
<span class="fc" id="L203">                summaries.add(date + &quot; &quot; + time);</span>
            } else {
<span class="nc" id="L205">                summaries.add(date.toString());</span>
            }
        }
<span class="fc" id="L208">        return summaries;</span>
    }

    private void applyStep1Model(Model model, WizardState state, String emailOverride, boolean emailError) {
<span class="fc" id="L212">        model.addAttribute(&quot;authorName&quot;, state.authorName());</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">        model.addAttribute(&quot;authorEmail&quot;, emailOverride != null ? emailOverride : state.authorEmail());</span>
<span class="fc" id="L214">        model.addAttribute(&quot;pollTitle&quot;, state.title());</span>
<span class="fc" id="L215">        model.addAttribute(&quot;description&quot;, state.description());</span>
<span class="fc" id="L216">        model.addAttribute(&quot;emailError&quot;, emailError);</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">        if (emailError) {</span>
<span class="fc" id="L218">            model.addAttribute(&quot;emailErrorMessage&quot;, EMAIL_ERROR_MESSAGE);</span>
        }
<span class="fc" id="L220">    }</span>

    private boolean isInvalidEmail(String authorEmail) {
<span class="pc bpc" id="L223" title="2 of 4 branches missed.">        if (authorEmail == null || authorEmail.isBlank()) {</span>
<span class="nc" id="L224">            return true;</span>
        }
<span class="fc" id="L226">        String trimmed = authorEmail.trim();</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">        return !trimmed.matches(&quot;^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$&quot;);</span>
    }

    private String resolveOptionsFragment(WizardState state) {
<span class="fc bfc" id="L231" title="All 2 branches covered.">        if (state.eventType() == io.github.bodote.woodle.domain.model.EventType.INTRADAY) {</span>
<span class="fc" id="L232">            return &quot;poll/step2-datetime-options :: dateTimeOptions&quot;;</span>
        }
<span class="fc" id="L234">        return &quot;poll/step2-date-options :: dateOptions&quot;;</span>
    }

    private int getOrInitDateCount(HttpSession session) {
<span class="fc" id="L238">        Object value = session.getAttribute(STEP2_DATE_COUNT);</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">        if (value instanceof Integer count) {</span>
<span class="fc" id="L240">            return count;</span>
        }
<span class="fc" id="L242">        session.setAttribute(STEP2_DATE_COUNT, STEP2_DEFAULT_DATES);</span>
<span class="fc" id="L243">        return STEP2_DEFAULT_DATES;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>